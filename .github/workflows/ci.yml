name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]
  repository_dispatch:
    types: [build-chain, upstream-changed]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: '1'
  CARGO_INCREMENTAL: '1'

jobs:
  setup:
    name: Setup
    runs-on: [self-hosted, linux, x64]
    outputs:
      cache-key: ${{ steps.setup-cache.outputs.cache-key }}
      consensus-cache-key: ${{ steps.setup-cache.outputs.consensus-cache-key }}
      protocol-cache-key: ${{ steps.setup-cache.outputs.protocol-cache-key }}
    steps:
      - name: Disk check
        run: |
          df -h
          if [ $(df / | tail -1 | awk '{print $5}' | sed 's/%//') -gt 80 ]; then
            find /tmp/runner-cache -maxdepth 2 -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
            df -h
          fi

      - uses: actions/checkout@v4
      
      - name: Checkout bllvm-protocol dependency
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-protocol
          path: _temp-protocol-engine
      
      - name: Checkout consensus
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-consensus
          path: _temp-consensus-proof
      
      - name: Move dependencies to parent directory
        run: |
          if [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi
          if [ -d "../bllvm-consensus" ]; then rm -rf ../bllvm-consensus; fi
          mv _temp-protocol-engine ../bllvm-protocol
          mv _temp-consensus-proof ../bllvm-consensus
      
      - name: Cache
        id: setup-cache
        run: |
          CACHE_ROOT="/tmp/runner-cache"
          
          # Generate cache keys from Cargo.lock hashes
          DEPS_KEY=$(sha256sum Cargo.lock | cut -d' ' -f1)
          CONSENSUS_DEPS_KEY=$(sha256sum ../bllvm-consensus/Cargo.lock | cut -d' ' -f1)
          PROTOCOL_DEPS_KEY=$(sha256sum ../bllvm-protocol/Cargo.lock | cut -d' ' -f1)
          
          # Include toolchain version in cache key
          TOOLCHAIN=$(grep -E '^channel|rust-version' rust-toolchain.toml Cargo.toml 2>/dev/null | head -1 | sha256sum | cut -d' ' -f1 || echo "1.88.0")
          
          CACHE_KEY="${DEPS_KEY}-${TOOLCHAIN}"
          CONSENSUS_CACHE_KEY="${CONSENSUS_DEPS_KEY}-${TOOLCHAIN}"
          PROTOCOL_CACHE_KEY="${PROTOCOL_DEPS_KEY}-${TOOLCHAIN}"
          
          # Set up cache directories
          CARGO_CACHE_DIR="$CACHE_ROOT/cargo/$CACHE_KEY"
          TARGET_CACHE_DIR="$CACHE_ROOT/target/$CACHE_KEY"
          CONSENSUS_TARGET_DIR="$CACHE_ROOT/bllvm-consensus-target/$CONSENSUS_CACHE_KEY"
          PROTOCOL_TARGET_DIR="$CACHE_ROOT/bllvm-protocol-target/$PROTOCOL_CACHE_KEY"
          
          echo "CARGO_CACHE_DIR=$CARGO_CACHE_DIR" >> $GITHUB_ENV
          echo "TARGET_CACHE_DIR=$TARGET_CACHE_DIR" >> $GITHUB_ENV
          echo "CONSENSUS_TARGET_DIR=$CONSENSUS_TARGET_DIR" >> $GITHUB_ENV
          echo "PROTOCOL_TARGET_DIR=$PROTOCOL_TARGET_DIR" >> $GITHUB_ENV
          
          echo "cache-key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "consensus-cache-key=$CONSENSUS_CACHE_KEY" >> $GITHUB_OUTPUT
          echo "protocol-cache-key=$PROTOCOL_CACHE_KEY" >> $GITHUB_OUTPUT
          
          mkdir -p "$CARGO_CACHE_DIR"/{registry,git} "$TARGET_CACHE_DIR" "$CONSENSUS_TARGET_DIR" "$PROTOCOL_TARGET_DIR"
          
          echo "  - Main: ${CACHE_KEY:0:16}..."
          echo "  - Consensus: ${CONSENSUS_CACHE_KEY:0:16}..."
          echo "  - Protocol: ${PROTOCOL_CACHE_KEY:0:16}..."

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0

  test:
    name: Test
    needs: setup
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Checkout bllvm-protocol dependency
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-protocol
          path: _temp-protocol-engine
      
      - name: Checkout consensus
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-consensus
          path: _temp-consensus-proof
      
      - name: Move dependencies to parent directory
        run: |
          if [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi
          if [ -d "../bllvm-consensus" ]; then rm -rf ../bllvm-consensus; fi
          mv _temp-protocol-engine ../bllvm-protocol
          mv _temp-consensus-proof ../bllvm-consensus
      
      - name: Cache
        run: |
          CACHE_ROOT="/tmp/runner-cache"
          CACHE_KEY="${{ needs.setup.outputs.cache-key }}"
          CONSENSUS_CACHE_KEY="${{ needs.setup.outputs.consensus-cache-key }}"
          PROTOCOL_CACHE_KEY="${{ needs.setup.outputs.protocol-cache-key }}"
          
          echo "CARGO_CACHE_DIR=$CACHE_ROOT/cargo/$CACHE_KEY" >> $GITHUB_ENV
          echo "TARGET_CACHE_DIR=$CACHE_ROOT/target/$CACHE_KEY" >> $GITHUB_ENV
          echo "CONSENSUS_TARGET_DIR=$CACHE_ROOT/bllvm-consensus-target/$CONSENSUS_CACHE_KEY" >> $GITHUB_ENV
          echo "PROTOCOL_TARGET_DIR=$CACHE_ROOT/bllvm-protocol-target/$PROTOCOL_CACHE_KEY" >> $GITHUB_ENV
      
      - name: Restore registry
        run: |
          if [ -d "$CARGO_CACHE_DIR/registry" ] && [ "$(ls -A $CARGO_CACHE_DIR/registry 2>/dev/null)" ]; then
            mkdir -p "$HOME/.cargo/registry"
            rsync -a --delete "$CARGO_CACHE_DIR/registry/" "$HOME/.cargo/registry/" || true
          else
            echo "üíø No Cargo registry cache found"
          fi
      
      - name: Restore git
        run: |
          if [ -d "$CARGO_CACHE_DIR/git" ] && [ "$(ls -A $CARGO_CACHE_DIR/git 2>/dev/null)" ]; then
            mkdir -p "$HOME/.cargo/git"
            rsync -a --delete "$CARGO_CACHE_DIR/git/" "$HOME/.cargo/git/" || true
          else
            echo "üíø No Cargo git cache found"
          fi
      
      - name: Restore consensus
        run: |
          if [ -d "$CONSENSUS_TARGET_DIR" ] && [ "$(ls -A $CONSENSUS_TARGET_DIR 2>/dev/null)" ]; then
            mkdir -p ../bllvm-consensus/target
            rsync -a --delete "$CONSENSUS_TARGET_DIR/" ../bllvm-consensus/target/ || true
          else
            echo "üíø No bllvm-consensus target cache found"
          fi
      
      - name: Restore bllvm-protocol build artifacts
        run: |
          if [ -d "$PROTOCOL_TARGET_DIR" ] && [ "$(ls -A $PROTOCOL_TARGET_DIR 2>/dev/null)" ]; then
            mkdir -p ../bllvm-protocol/target
            rsync -a --delete "$PROTOCOL_TARGET_DIR/" ../bllvm-protocol/target/ || true
          else
            echo "üíø No bllvm-protocol target cache found"
          fi
      
      - name: Restore target
        run: |
          if [ -d "$TARGET_CACHE_DIR" ] && [ "$(ls -A $TARGET_CACHE_DIR 2>/dev/null)" ]; then
            rsync -a --delete "$TARGET_CACHE_DIR/" ./target/ || true
          else
            echo "üíø No target cache found, will build from scratch"
          fi
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0
      
      - name: Run tests
        run: cargo test --workspace --all-features --verbose
      
      - name: Cache registry
        if: always()
        run: |
          if [ -d "$HOME/.cargo/registry" ] && [ "$CARGO_CACHE_DIR" != "" ]; then
            rsync -a --delete "$HOME/.cargo/registry/" "$CARGO_CACHE_DIR/registry/" || true
          fi
      
      - name: Cache git
        if: always()
        run: |
          if [ -d "$HOME/.cargo/git" ] && [ "$CARGO_CACHE_DIR" != "" ]; then
            rsync -a --delete "$HOME/.cargo/git/" "$CARGO_CACHE_DIR/git/" || true
          fi
      
      - name: Cache consensus
        if: always()
        run: |
          if [ -d "../bllvm-consensus/target" ] && [ "$CONSENSUS_TARGET_DIR" != "" ]; then
            rsync -a --delete ../bllvm-consensus/target/ "$CONSENSUS_TARGET_DIR/" || true
          fi
      
      - name: Cache bllvm-protocol build artifacts
        if: always()
        run: |
          if [ -d "../bllvm-protocol/target" ] && [ "$PROTOCOL_TARGET_DIR" != "" ]; then
            rsync -a --delete ../bllvm-protocol/target/ "$PROTOCOL_TARGET_DIR/" || true
          fi
      
      - name: Cache target
        if: always()
        run: |
          if [ -d "./target" ] && [ "$TARGET_CACHE_DIR" != "" ]; then
            rsync -a --delete ./target/ "$TARGET_CACHE_DIR/" || true
          fi
      
      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up old caches..."
          CACHE_ROOT="/tmp/runner-cache"
          find "$CACHE_ROOT/cargo" -maxdepth 1 -type d -mtime +1 2>/dev/null | head -n -5 | xargs rm -rf 2>/dev/null || true
          find "$CACHE_ROOT/target" -maxdepth 1 -type d -mtime +1 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true
          find "$CACHE_ROOT/bllvm-consensus-target" -maxdepth 1 -type d -mtime +1 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true
          find "$CACHE_ROOT/bllvm-protocol-target" -maxdepth 1 -type d -mtime +1 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true

  lint:
    name: Lint
    needs: setup
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache
        run: |
          CACHE_ROOT="/tmp/runner-cache"
          CACHE_KEY="${{ needs.setup.outputs.cache-key }}"
          echo "CARGO_CACHE_DIR=$CACHE_ROOT/cargo/$CACHE_KEY" >> $GITHUB_ENV
      
      - name: Restore registry
        run: |
          if [ -d "$CARGO_CACHE_DIR/registry" ] && [ "$(ls -A $CARGO_CACHE_DIR/registry 2>/dev/null)" ]; then
            mkdir -p "$HOME/.cargo/registry"
            rsync -a --delete "$CARGO_CACHE_DIR/registry/" "$HOME/.cargo/registry/" || true
          fi
      
      - name: Restore git
        run: |
          if [ -d "$CARGO_CACHE_DIR/git" ] && [ "$(ls -A $CARGO_CACHE_DIR/git 2>/dev/null)" ]; then
            mkdir -p "$HOME/.cargo/git"
            rsync -a --delete "$CARGO_CACHE_DIR/git/" "$HOME/.cargo/git/" || true
          fi
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0
          components: clippy, rustfmt
      
      - name: Run clippy
        run: cargo clippy --workspace --all-features -- -D warnings
      
      - name: Check formatting
        run: cargo fmt -- --check

  security:
    name: Security
    needs: setup
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Checkout bllvm-protocol dependency
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-protocol
          path: _temp-protocol-engine
      
      - name: Checkout consensus
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-consensus
          path: _temp-consensus-proof
      
      - name: Checkout bllvm-node dependency
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-node
          path: _temp-node
      
      - name: Move dependencies to parent directory
        run: |
          echo "Current directory: $(pwd)"
          echo "Workspace: ${{ github.workspace }}"
          echo "Listing current directory:"
          ls -la
          echo "Listing parent directory:"
          ls -la .. || true
          echo "Checking for temp directories:"
          ls -la _temp-* || echo "No _temp-* directories found"
          if [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi
          if [ -d "../bllvm-consensus" ]; then rm -rf ../bllvm-consensus; fi
          if [ -d "../bllvm-node" ]; then rm -rf ../bllvm-node; fi
          if [ -d "_temp-protocol-engine" ]; then mv _temp-protocol-engine ../bllvm-protocol; else echo "ERROR: _temp-protocol-engine not found!"; exit 1; fi
          if [ -d "_temp-consensus-proof" ]; then mv _temp-consensus-proof ../bllvm-consensus; else echo "ERROR: _temp-consensus-proof not found!"; exit 1; fi
          if [ -d "_temp-node" ]; then mv _temp-node ../bllvm-node; else echo "ERROR: _temp-node not found!"; exit 1; fi
          echo "Listing parent directory after move:"
          ls -la .. | grep bllvm || echo "No bllvm directories found in parent"
          echo "Verifying bllvm-node exists:"
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.89.0
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --version 0.22.0
      
      - name: Run security audit
        run: cargo audit

  build:
    name: Build
    needs: [setup, test, lint, security]
    runs-on: [self-hosted, linux, x64]
    if: github.event_name == 'push' || github.event_name == 'release' || github.event_name == 'repository_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Checkout bllvm-protocol dependency
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-protocol
          path: _temp-protocol-engine
      
      - name: Checkout consensus
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm-consensus
          path: _temp-consensus-proof
      
      - name: Move dependencies to parent directory
        run: |
          if [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi
          if [ -d "../bllvm-consensus" ]; then rm -rf ../bllvm-consensus; fi
          mv _temp-protocol-engine ../bllvm-protocol
          mv _temp-consensus-proof ../bllvm-consensus
      
      - name: Cache
        run: |
          CACHE_ROOT="/tmp/runner-cache"
          CACHE_KEY="${{ needs.setup.outputs.cache-key }}"
          CONSENSUS_CACHE_KEY="${{ needs.setup.outputs.consensus-cache-key }}"
          PROTOCOL_CACHE_KEY="${{ needs.setup.outputs.protocol-cache-key }}"
          
          echo "CARGO_CACHE_DIR=$CACHE_ROOT/cargo/$CACHE_KEY" >> $GITHUB_ENV
          echo "TARGET_CACHE_DIR=$CACHE_ROOT/target/$CACHE_KEY" >> $GITHUB_ENV
          echo "CONSENSUS_TARGET_DIR=$CACHE_ROOT/bllvm-consensus-target/$CONSENSUS_CACHE_KEY" >> $GITHUB_ENV
          echo "PROTOCOL_TARGET_DIR=$CACHE_ROOT/bllvm-protocol-target/$PROTOCOL_CACHE_KEY" >> $GITHUB_ENV
      
      - name: Restore registry
        run: |
          if [ -d "$CARGO_CACHE_DIR/registry" ] && [ "$(ls -A $CARGO_CACHE_DIR/registry 2>/dev/null)" ]; then
            mkdir -p "$HOME/.cargo/registry"
            rsync -a --delete "$CARGO_CACHE_DIR/registry/" "$HOME/.cargo/registry/" || true
          fi
      
      - name: Restore git
        run: |
          if [ -d "$CARGO_CACHE_DIR/git" ] && [ "$(ls -A $CARGO_CACHE_DIR/git 2>/dev/null)" ]; then
            mkdir -p "$HOME/.cargo/git"
            rsync -a --delete "$CARGO_CACHE_DIR/git/" "$HOME/.cargo/git/" || true
          fi
      
      - name: Restore consensus
        run: |
          if [ -d "$CONSENSUS_TARGET_DIR" ] && [ "$(ls -A $CONSENSUS_TARGET_DIR 2>/dev/null)" ]; then
            mkdir -p ../bllvm-consensus/target
            rsync -a --delete "$CONSENSUS_TARGET_DIR/" ../bllvm-consensus/target/ || true
          fi
      
      - name: Restore bllvm-protocol build artifacts
        run: |
          if [ -d "$PROTOCOL_TARGET_DIR" ] && [ "$(ls -A $PROTOCOL_TARGET_DIR 2>/dev/null)" ]; then
            mkdir -p ../bllvm-protocol/target
            rsync -a --delete "$PROTOCOL_TARGET_DIR/" ../bllvm-protocol/target/ || true
          fi
      
      - name: Restore target
        run: |
          if [ -d "$TARGET_CACHE_DIR" ] && [ "$(ls -A $TARGET_CACHE_DIR 2>/dev/null)" ]; then
            rsync -a --delete "$TARGET_CACHE_DIR/" ./target/ || true
          fi
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0
      
      - name: Build
        run: cargo build --workspace --release --all-features
      
      - name: Cache consensus
        if: always()
        run: |
          if [ -d "../bllvm-consensus/target" ] && [ "$CONSENSUS_TARGET_DIR" != "" ]; then
            rsync -a --delete ../bllvm-consensus/target/ "$CONSENSUS_TARGET_DIR/" || true
          fi
      
      - name: Cache bllvm-protocol build artifacts
        if: always()
        run: |
          if [ -d "../bllvm-protocol/target" ] && [ "$PROTOCOL_TARGET_DIR" != "" ]; then
            rsync -a --delete ../bllvm-protocol/target/ "$PROTOCOL_TARGET_DIR/" || true
          fi
      
      - name: Cache target
        if: always()
        run: |
          if [ -d "./target" ] && [ "$TARGET_CACHE_DIR" != "" ]; then
            rsync -a --delete ./target/ "$TARGET_CACHE_DIR/" || true
          fi

  release:
    name: Release
    needs: build
    runs-on: [self-hosted, linux, x64]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      !contains(github.event.head_commit.message, '[skip release]')
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0
      
      - name: Determine version
        id: version
        run: |
          # Auto-increment patch version from Cargo.toml
          CURRENT=$(grep -E '^version = ' Cargo.toml | sed -E 's/^version = "([^"]+)".*/\1/')
          if [ -z "$CURRENT" ]; then
            echo "‚ùå Could not determine current version from Cargo.toml"
            exit 1
          fi
          
          # Increment patch version (X.Y.Z -> X.Y.(Z+1))
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)
          PATCH=$((PATCH + 1))
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          
          # Remove 'v' prefix if present
          VERSION=$(echo "$VERSION" | sed 's/^v//')
          VERSION_TAG="v${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Releasing version: ${VERSION_TAG}"
      
      - name: Get latest bllvm-node version from crates.io
        id: node-version
        run: |
          NODE_VER=$(cargo search bllvm-node --limit 1 2>/dev/null | head -1 | sed -E 's/^bllvm-node = "([^"]+)".*/\1/' || echo "")
          if [ -z "$NODE_VER" ]; then
            echo "‚ùå bllvm-node not found on crates.io. It must be published first."
            exit 1
          fi
          echo "version=${NODE_VER}" >> $GITHUB_OUTPUT
          echo "Using bllvm-node version: ${NODE_VER}"
      
      - name: Update Cargo.toml to use crates.io dependencies
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NODE_VER="${{ steps.node-version.outputs.version }}"
          
          # Update version
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml
          
          # Update bllvm-node dependency to use crates.io version
          sed -i 's|bllvm-node = { path = "\.\./bllvm-node"|bllvm-node = "'"${NODE_VER}"'"|g' Cargo.toml
          
          echo "Updated Cargo.toml:"
          echo "  version: ${VERSION}"
          echo "  bllvm-node: ${NODE_VER}"
          grep -E "^(version|bllvm-node)" Cargo.toml
      
      - name: Check for crates.io token
        run: |
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "‚ö†Ô∏è  CARGO_REGISTRY_TOKEN not set, skipping crate publication"
            echo "   Set CARGO_REGISTRY_TOKEN secret to enable crate publishing"
            exit 0
          fi
      
      - name: Configure cargo for crates.io
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: |
          cargo login "${CARGO_REGISTRY_TOKEN}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Verify package
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: |
          cargo package --list
      
      - name: Dry-run publish
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: |
          cargo publish --dry-run
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Check if version already exists
        if: env.CARGO_REGISTRY_TOKEN != ''
        id: check-version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CRATE_NAME=$(grep -E '^name = ' Cargo.toml | sed -E 's/^name = "([^"]+)".*/\1/')
          if cargo search "$CRATE_NAME" --limit 1 2>/dev/null | grep -q "v${VERSION}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Version ${VERSION} already published for ${CRATE_NAME}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Version ${VERSION} not yet published for ${CRATE_NAME}"
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Publish to crates.io
        if: |
          env.CARGO_REGISTRY_TOKEN != '' &&
          steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CRATE_NAME=$(grep -E '^name = ' Cargo.toml | sed -E 's/^name = "([^"]+)".*/\1/')
          echo "Publishing ${CRATE_NAME} v${VERSION} to crates.io..."
          cargo publish --token "${CARGO_REGISTRY_TOKEN}"
          echo "‚úÖ Successfully published ${CRATE_NAME} v${VERSION}"
          echo "Waiting 30 seconds for crates.io to index..."
          sleep 30
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Create git tag
        run: |
          VERSION_TAG="${{ steps.version.outputs.version_tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if tag already exists
          if git rev-parse "$VERSION_TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag ${VERSION_TAG} already exists, skipping tag creation"
          else
            git tag -a "$VERSION_TAG" -m "Release ${VERSION_TAG}"
            git push origin "$VERSION_TAG"
            echo "‚úÖ Created and pushed tag ${VERSION_TAG}"
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: Release ${{ steps.version.outputs.version_tag }}
          body: |
            ## ${{ steps.version.outputs.version_tag }}
            
            Automated release of bllvm-sdk.
            
            **Published to crates.io**: ${{ steps.check-version.outputs.exists == 'false' && '‚úÖ Yes' || '‚ö†Ô∏è  Already exists or skipped' }}
            
            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

